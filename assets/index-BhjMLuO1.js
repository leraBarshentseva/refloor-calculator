(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))o(r);new MutationObserver(r=>{for(const c of r)if(c.type==="childList")for(const l of c.addedNodes)l.tagName==="LINK"&&l.rel==="modulepreload"&&o(l)}).observe(document,{childList:!0,subtree:!0});function a(r){const c={};return r.integrity&&(c.integrity=r.integrity),r.referrerPolicy&&(c.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?c.credentials="include":r.crossOrigin==="anonymous"?c.credentials="omit":c.credentials="same-origin",c}function o(r){if(r.ep)return;r.ep=!0;const c=a(r);fetch(r.href,c)}})();const b="refloor_calculator_state",s={brick:"visualizer__brick",brickMain:"visualizer__brick--base",brickAdd:"visualizer__brick--add",brickRemove:"visualizer__brick--remove",input:"visualizer__brick-input",removeButton:"visualizer__brick-remove",areaBrick:"visualizer__brick-area",errorBrick:"is-error",isDeleting:"is-deleting",isAppearing:"is-appearing"},y={MATERIAL:"pvc",LAYING:"direct",MAIN_WIDTH:3,MAIN_LENGTH:4},E={mainRoom:{width:y.MAIN_WIDTH,length:y.MAIN_LENGTH},segments:[],materialType:y.MATERIAL,layingMethod:y.LAYING},B={pvc:{price:1200,packSize:2.5},"spc-laminate":{price:1800,packSize:2.2},"quartz-parquet":{price:2500,packSize:1.8}},z={direct:{waste:5},diagonal:{waste:10},herringbone:{waste:15}},L=e=>{let t=parseFloat(e.value);return isNaN(t)?0:(t<0&&(t=Math.abs(t),e.value=t),t)},m=(e,t)=>{e.textContent!==t&&(e.classList.remove(`${s.isUpdateText}`),e.textContent=t,e.animate([{transform:"scale(1)",color:"inherit"},{transform:"scale(1.1)",color:"#8CCB5E",offset:.5},{transform:"scale(1)",color:"inherit"}],{duration:300,easing:"ease-out"}))},M=(e,t)=>{const a=e.querySelector(".visualizer__error-tooltip");a&&a.remove();const o=document.createElement("div");o.className="visualizer__error-tooltip",o.textContent=t,e.appendChild(o),setTimeout(()=>{o.remove()},3e3)},R=()=>{const e=localStorage.getItem(b);if(!e)return structuredClone(E);try{return JSON.parse(e)}catch{return console.warn("Ошибка чтения данных, сброс калькулятора"),localStorage.removeItem(b),structuredClone(E)}},i=R(),N=()=>{localStorage.setItem(b,JSON.stringify(i))},C=()=>{localStorage.removeItem(b)},q=()=>{const e=structuredClone(E);Object.assign(i,e)},n={mainRoom:{widthInput:document.getElementById("width"),lengthInput:document.getElementById("length")},baseBrick:{width:document.getElementById("base-brick-width"),length:document.getElementById("base-brick-length"),area:document.getElementById("base-brick-area")},buttons:{addSegment:document.querySelector('[data-action="add-segment"]'),subtractSegment:document.querySelector('[data-action="subtract-segment"]'),resetButton:document.querySelector(".calculator__reset-btn")},selects:{materialType:document.getElementById("material-type"),layingMethod:document.getElementById("laying-method")},containers:{visualizer:document.querySelector(".calculator__visualizer")},results:{area:document.getElementById("result-area"),waste:document.getElementById("result-waste"),material:document.getElementById("result-material"),totalPrice:document.getElementById("result-total-price"),packSize:document.getElementById("result-pack-size"),packCount:document.getElementById("result-pack-count"),pricePerMeter:document.getElementById("result-price-per-meter")}},D=()=>{let e=i.mainRoom.width*i.mainRoom.length;i.segments.length>0&&i.segments.forEach(g=>{const h=g.width*g.length;e+=g.type==="add"?h:-h}),e=Math.max(0,e);const t=B[i.materialType],o=z[i.layingMethod].waste,r=e*(o/100),c=e+r,l=Math.ceil(c/t.packSize),d=l*t.packSize,S=d*t.price;return{baseArea:e,wastePercent:o,wasteArea:r,finalAreaToBuy:d,totalPrice:S,packsNeeded:l,packSize:t.packSize,pricePerMeter:t.price}},P=()=>{confirm("Вы уверены, что хотите сбросить расчет?")&&(q(),C(),W(),A(),_(),k(),u())},x=e=>{i.segments=i.segments.filter(t=>t.id!==e),H(e),u()},H=e=>{const t=n.containers.visualizer.querySelector(`[data-id="${e}"]`);t&&(t.classList.add(s.isDeleting),setTimeout(()=>{t.remove()},300))},F=(e,t)=>{let a=0;for(const o of i.segments)if(o.type===e&&(a++,o.id===t))return a;return a},I=e=>{const t={id:crypto.randomUUID(),type:e,width:0,length:0};i.segments.push(t),w(t),u();const a=n.containers.visualizer.querySelector(`[data-id="${t.id}"]`);if(a){const o=a.querySelector('input[name="width"]');o&&o.focus()}},w=e=>{const t=O(e);n.containers.visualizer.insertAdjacentHTML("beforeend",t)},O=e=>{const t=F(e.type,e.id),a=e.type==="add"?s.brickAdd:s.brickRemove,o=e.type==="add"?`Доп. площадь #${t}`:`Вычет #${t}`,r=e.type==="add"?"+":"−",c=e.width*e.length;return`
      <div class="${s.brick} ${a} ${s.isAppearing}" data-id="${e.id}">
        <h5 class="visualizer__brick-title">${o}</h5>
        <button class="${s.removeButton}" aria-label="Удалить этот сегмент">×</button>
        <div class="visualizer__brick-body">
          <div class="visualizer__brick-group">
            <span class="visualizer__brick-label">Ширина</span>
            <input class="${s.input}" name="width" type="number" value="${e.width}" min="0">
          </div>
          <span>×</span>
          <div class="visualizer__brick-group">
            <span class="visualizer__brick-label">Длина</span>
            <input class="${s.input}" name="length" type="number" value="${e.length}" min="0">
          </div>
        </div>
        <div class="${s.areaBrick}">${r} S = ${c.toFixed(2)} м<sup>2</sup></div>
      </div>
    `},U=e=>{m(n.results.area,`${e.baseArea.toFixed(2)} м²`),m(n.results.waste,`${e.wasteArea.toFixed(2)} м² (${e.wastePercent}%)`),m(n.results.material,`${e.finalAreaToBuy.toFixed(2)} м²`),m(n.results.packSize,`${e.packSize} м²`),m(n.results.packCount,`${e.packsNeeded} шт.`),m(n.results.pricePerMeter,`${e.pricePerMeter.toLocaleString("ru-RU")} ₽`),m(n.results.totalPrice,`${e.totalPrice.toLocaleString("ru-RU",{maximumFractionDigits:0})} ₽`)},u=()=>{N();const e=D();U(e)},k=()=>{n.baseBrick.width.value=i.mainRoom.width,n.baseBrick.length.value=i.mainRoom.length,n.baseBrick.area.innerHTML=`S = ${(i.mainRoom.width*i.mainRoom.length).toFixed(2)} м<sup>2</sup>`},G=()=>{i.segments.length!==0&&i.segments.forEach(e=>{w(e)})},A=()=>{n.selects.materialType&&(n.selects.materialType.value=i.materialType),n.selects.layingMethod&&(n.selects.layingMethod.value=i.layingMethod)},_=()=>{n.mainRoom.widthInput.value=i.mainRoom.width,n.mainRoom.lengthInput.value=i.mainRoom.length},W=()=>{n.containers.visualizer.querySelectorAll(`.${s.brick}:not(.${s.brickMain})`).forEach(t=>t.remove())},Y=e=>{const t=e.target.closest(`.${s.input}`);if(!t)return;const a=t.closest(`.${s.brick}`);if(a.classList.contains(`${s.brickMain}`))return;const o=a.dataset.id,r=i.segments.find(v=>v.id===o),c=t.name==="width",l=t.name==="length",d=L(t);if(r.type==="subtract"){let v=i.mainRoom.width*i.mainRoom.length;i.segments.forEach(p=>{if(p.id===o)return;const f=p.width*p.length;p.type==="add"?v+=f:v-=f});const $=c?d:r.width;if((l?d:r.length)*$>v){const p=a.querySelector('input[name="width"]'),f=a.querySelector('input[name="length"]');p.value=0,f.value=0,a.classList.add(`${s.errorBrick}`),setTimeout(()=>{a.classList.remove(`${s.errorBrick}`)},500),M(a,"Вычитаемая площадь больше исходной"),r.width=0,r.length=0;const T=a.querySelector(`.${s.areaBrick}`);T.innerHTML="− S = 0.00 м<sup>2</sup>",u();return}}c&&(r.width=d),l&&(r.length=d);const S=a.querySelector(`.${s.areaBrick}`),g=r.type==="add"?"+":"−",h=r.width*r.length;S.innerHTML=`${g} S = ${h.toFixed(2)} м<sup>2</sup>`,u()},j=()=>{document.addEventListener("keydown",e=>{e.target.type==="number"&&["-","+","e","E"].includes(e.key)&&e.preventDefault()}),n.containers.visualizer.addEventListener("animationend",e=>{e.target.classList.contains(`${s.isAppearing}`)&&e.target.classList.remove(`${s.isAppearing}`)}),n.buttons.resetButton.addEventListener("click",P),n.buttons.addSegment.addEventListener("click",e=>{e.preventDefault(),I("add")}),n.buttons.subtractSegment.addEventListener("click",e=>{e.preventDefault(),I("subtract")}),n.mainRoom.widthInput.addEventListener("input",e=>{i.mainRoom.width=L(n.mainRoom.widthInput),k(),u()}),n.mainRoom.lengthInput.addEventListener("input",e=>{i.mainRoom.length=L(n.mainRoom.lengthInput),k(),u()}),n.selects.materialType.addEventListener("change",()=>{i.materialType=n.selects.materialType.value,u()}),n.selects.layingMethod.addEventListener("change",()=>{i.layingMethod=n.selects.layingMethod.value,u()}),n.containers.visualizer.addEventListener("click",e=>{const t=e.target.closest(`.${s.removeButton}`);if(!t)return;e.preventDefault();const a=t.closest(`.${s.brick}`);x(a.dataset.id)}),n.containers.visualizer.addEventListener("input",e=>{Y(e)}),n.containers.visualizer.addEventListener("focusin",e=>{const t=e.target.closest(`.${s.input}`);t&&t.value==="0"&&(t.value="")}),n.containers.visualizer.addEventListener("focusout",e=>{const t=e.target.closest(`.${s.input}`);t&&t.value===""&&(t.value="0")})},J=()=>{j(),i.segments.length>0&&G(),A(),_(),k(),u()};J();
